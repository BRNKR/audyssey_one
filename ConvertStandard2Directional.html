<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bass Mode Converter</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        h1 {
            color: #333;
        }
        label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
        }
        input[type="file"] {
            margin-bottom: 20px;
        }
        p {
            font-size: small;
            color: red;
        }
        pre {
            background-color: #f4f4f4;
            padding: 10px;
            border: 1px solid #ccc;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>Convert calibration file measured with '3 mic points at MLP with switching subs' method to 'Directional Bass' mode</h1>
    <label for="json-file">Upload your measurement .ady file:</label>
    <input type="file" id="json-file" accept=".ady" onchange="handleFileSelect(event)" />
    <p>Please ensure the .ady file is created with these specific measurements:</p>
    <ul>
        <li>All 3 measurements at MLP, calibration mic should not be moved</li>
        <li>Audyssey will be thinking it's measuring a system with just 1 subwoofer</li>
        <li>First 2 measurements: Only subwoofer 1 plugged in SW1 preout of the receiver</li>
        <li>Third measurement: Only subwoofer 2 plugged in SW1 preout of the receiver</li>

    </ul>
    <p>Swap subs between the second and third measurements.</p>
    <p>Subs should not have major volume differences</p>
    <p>Script is for receivers with 2 independent subwoofer outputs but no directional bass mode</p>
    <p><strong>Note:</strong> A1 Evo will optimize the converted calibration file and produce a file with two perfectly aligned subwoofers in standard bass mode</p>
    <pre id="modified-json"></pre>

    <script>
        function handleFileSelect(event) {
            const file = event.target.files[0];
            const reader = new FileReader();

            reader.onload = function (e) {
                const json = e.target.result;
                const data = JSON.parse(json);

                // Modify JSON data as needed
                data.subwooferMode = "Directional";
                data.subwooferLayout = "Front/Rear";
                data.subwooferNum = "2";

                let detectedChannels = data.detectedChannels;
                let lastEnChannelType = detectedChannels[detectedChannels.length - 1].enChannelType;
                lastEnChannelType++;

                // Add new channel configuration
                const newLastChannel = {
                    "enChannelType": lastEnChannelType,
                    "isSkipMeasurement": false,
                    "delayAdjustment": "0.00",
                    "commandId": "SW2",
                    "trimAdjustment": "0.0",
                    "channelReport": {
                        "enSpeakerConnect": 3,
                        "isReversePolarity": true,
                        "distance": 3.00
                    },
                    "responseData": {},
                    "referenceCurveFilter": {},
                    "midrangeCompensation": true,
                    "frequencyRangeRolloff": 250.0,
                    "customDistance": 3.0,
                    "customLevel": "0.0"
                };
                data.detectedChannels.push(newLastChannel);

                detectedChannels = data.detectedChannels;

                if (detectedChannels.length > 1) {
                    const lastChannel = detectedChannels[detectedChannels.length - 1];
                    const secondLastChannel = detectedChannels[detectedChannels.length - 2];
                    const responseData = secondLastChannel.responseData;

                    if (responseData && Object.keys(responseData).length > 2) {
                        const dataToCopy = responseData["2"];
                        lastChannel.responseData = [dataToCopy, dataToCopy, dataToCopy];
                        secondLastChannel.responseData[2] = responseData["0"];
                    }

                    lastChannel.delayAdjustment = "0.0";
                    lastChannel.trimAdjustment = "0.0";
                    secondLastChannel.delayAdjustment = "0.0";
                    secondLastChannel.trimAdjustment = "0.0";

                    const polarity = secondLastChannel.channelReport.isReversePolarity;
                    lastChannel.channelReport.isReversePolarity = polarity;
                }

                // Prepare modified JSON for download
                const modifiedJSON = JSON.stringify(data, null, 2);
                const blob = new Blob([modifiedJSON], { type: "application/json" });
                const url = URL.createObjectURL(blob);

                // Create download link and trigger download
                const downloadLink = document.createElement("a");
                downloadLink.href = url;
                downloadLink.download = getModifiedFileName(file.name, "_directional");
                downloadLink.style.display = "none";
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
            };

            reader.readAsText(file);
        }

        function getModifiedFileName(fileName, suffix) {
            const dotIndex = fileName.lastIndexOf(".");
            const modifiedName = fileName.substring(0, dotIndex) + suffix + fileName.substring(dotIndex);
            return modifiedName;
        }
    </script>
</body>
</html>
